# Roadmap Integration Workflow
# Automatically tracks issues and updates roadmap based on git activity

name: ğŸ—ºï¸ Roadmap Integration

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
    types: [ opened, synchronize, closed ]
  workflow_dispatch:

env:
  ROADMAP_AUTO_TRACK: true
  ROADMAP_PROGRESS_TRACKING: true

jobs:
  roadmap-tracking:
    runs-on: ubuntu-latest
    name: Track Roadmap Changes

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comprehensive tracking

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Roadmap CLI
      run: |
        pip install --upgrade pip
        # Install from PyPI when published, for now install locally
        pip install -e .

    - name: ğŸ” Initialize Roadmap (if needed)
      run: |
        if [ ! -f ".roadmap/config.yaml" ]; then
          echo "Initializing roadmap for CI/CD tracking..."
          roadmap init --name "${{ github.repository }}" --auto-confirm
        fi

    - name: ğŸ¯ Track Commit Changes
      if: github.event_name == 'push'
      run: |
        echo "ğŸ” Scanning recent commits for roadmap updates..."
        roadmap ci scan-repository --max-commits 10

        # Track specific commits in this push
        for commit in $(git log --format="%H" ${{ github.event.before }}..${{ github.event.after }}); do
          echo "ğŸ“ Tracking commit: $commit"
          roadmap ci track-commit "$commit" || true
        done

    - name: ğŸ”€ Track Pull Request
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ” Tracking PR #${{ github.event.number }}: ${{ github.event.pull_request.title }}"

        # Extract issue IDs from PR title and body
        PR_TEXT="${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }}"

        # Track PR association
        roadmap ci track-pr \
          --number "${{ github.event.number }}" \
          --title "${{ github.event.pull_request.title }}" \
          --branch "${{ github.event.pull_request.head.ref }}" \
          --state "${{ github.event.pull_request.state }}" || true

    - name: âœ… Handle PR Merge
      if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
      run: |
        echo "ğŸ‰ PR #${{ github.event.number }} merged! Processing completion..."

        # Scan merged commits for completion
        roadmap ci scan-repository --max-commits 5

        # Mark associated issues as potentially complete
        echo "ğŸ Checking for issue completion in merged PR..."

    - name: ğŸ“Š Generate Roadmap Status Report
      run: |
        echo "ğŸ“ˆ Current roadmap status:"
        roadmap status || true

        echo "ğŸ”§ CI/CD tracking status:"
        roadmap ci status || true

        echo "ğŸ“‹ Recent activity:"
        roadmap activity || true

    - name: ğŸ’¾ Commit Roadmap Updates
      if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action == 'closed')
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Roadmap Integration"

        # Check if there are changes to commit
        if git diff --quiet HEAD -- .roadmap/; then
          echo "ğŸ“ No roadmap changes to commit"
        else
          echo "ğŸ’¾ Committing roadmap updates..."
          git add .roadmap/
          git commit -m "ğŸ¤– Auto-update roadmap from CI/CD tracking

          - Processed commits from ${{ github.event_name }} event
          - Updated issue associations and progress
          - Automated via GitHub Actions" || true

          # Push changes back to repository
          git push || echo "âš ï¸  Could not push roadmap updates (may need write permissions)"
        fi

    - name: ğŸ“ Comment on PR (if applicable)
      if: github.event_name == 'pull_request' && github.event.action == 'opened'
      uses: actions/github-script@v7
      with:
        script: |
          // Add a comment with roadmap integration info
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ—ºï¸ **Roadmap Integration**

            This PR has been automatically tracked by the roadmap system.

            - ğŸ” **Branch analysis**: Scanning for issue associations
            - ğŸ“Š **Progress tracking**: Monitoring commit progress markers
            - ğŸ¯ **Auto-completion**: Will process completion on merge

            Use commit messages like \`[progress:50%]\` or \`[closes roadmap:issue-id]\` for automatic updates!`
          });
