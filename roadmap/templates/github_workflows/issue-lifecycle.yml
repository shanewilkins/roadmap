# Issue Lifecycle Automation
# Advanced workflow for managing issue states based on git activity

name: ğŸ¯ Issue Lifecycle Management

on:
  push:
    branches: [ main, master, develop, 'feature/**', 'hotfix/**', 'bugfix/**' ]
  pull_request:
    types: [ opened, synchronize, ready_for_review, closed ]
  create:
    # Trigger when branches are created
  delete:
    # Trigger when branches are deleted

env:
  ROADMAP_AUTO_TRANSITIONS: true
  ROADMAP_DEPENDENCY_CHECKING: true

jobs:
  issue-lifecycle:
    runs-on: ubuntu-latest
    name: ğŸ”„ Manage Issue Lifecycle
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ Setup Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Roadmap CLI
      run: |
        pip install --upgrade pip
        pip install -e .
        
    - name: ğŸŒ¿ Handle Branch Creation
      if: github.event_name == 'create' && github.event.ref_type == 'branch'
      run: |
        BRANCH_NAME="${{ github.event.ref }}"
        echo "ğŸŒ¿ New branch created: $BRANCH_NAME"
        
        # Extract issue ID from branch name
        if [[ $BRANCH_NAME =~ ([a-f0-9]{8}) ]]; then
          ISSUE_ID="${BASH_REMATCH[1]}"
          echo "ğŸ¯ Found issue ID: $ISSUE_ID"
          
          # Track branch creation and potentially start issue
          roadmap ci track-branch "$BRANCH_NAME"
          
          echo "âœ… Issue $ISSUE_ID associated with branch $BRANCH_NAME"
        else
          echo "â„¹ï¸  Branch doesn't follow issue naming convention"
        fi
        
    - name: ğŸ—‘ï¸ Handle Branch Deletion
      if: github.event_name == 'delete' && github.event.ref_type == 'branch'
      run: |
        BRANCH_NAME="${{ github.event.ref }}"
        echo "ğŸ—‘ï¸  Branch deleted: $BRANCH_NAME"
        
        # Clean up branch associations (but preserve commit history)
        echo "ğŸ§¹ Cleaning up branch associations..."
        # Note: We'll implement branch cleanup in CI commands
        
    - name: ğŸ“ Handle Commit Activity
      if: github.event_name == 'push'
      run: |
        echo "ğŸ“ Processing commits from push event..."
        
        # Get list of new commits
        COMMITS=$(git log --format="%H" ${{ github.event.before }}..${{ github.event.after }})
        
        for COMMIT in $COMMITS; do
          echo "ğŸ” Processing commit: $COMMIT"
          
          # Track commit and extract issue associations
          RESULT=$(roadmap ci track-commit "$COMMIT")
          echo "$RESULT"
          
          # Check for progress updates or completion markers
          COMMIT_MSG=$(git log -1 --format="%s" "$COMMIT")
          echo "ğŸ“„ Message: $COMMIT_MSG"
          
          # Look for dependency updates or blockers
          if [[ $COMMIT_MSG =~ (unblock|depends|blocks) ]]; then
            echo "ğŸ”— Dependency-related commit detected"
            # Future: Handle dependency resolution
          fi
        done
        
    - name: ğŸ”€ Handle Pull Request Events
      if: github.event_name == 'pull_request'
      run: |
        PR_NUMBER="${{ github.event.number }}"
        PR_ACTION="${{ github.event.action }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_BRANCH="${{ github.event.pull_request.head.ref }}"
        
        echo "ğŸ”€ PR Event: #$PR_NUMBER ($PR_ACTION)"
        echo "ğŸ“ Title: $PR_TITLE"
        echo "ğŸŒ¿ Branch: $PR_BRANCH"
        
        case "$PR_ACTION" in
          "opened"|"ready_for_review")
            echo "ğŸ¯ PR opened - checking for issue associations..."
            
            # Extract issue IDs from PR branch, title, and body
            PR_TEXT="$PR_TITLE ${{ github.event.pull_request.body }}"
            
            # Track PR and associate with issues
            roadmap ci track-pr \
              --number "$PR_NUMBER" \
              --title "$PR_TITLE" \
              --branch "$PR_BRANCH" \
              --state "open"
              
            echo "âœ… PR tracked in roadmap system"
            ;;
            
          "synchronize")
            echo "ğŸ”„ PR updated - scanning new commits..."
            
            # Get new commits in PR
            git fetch origin "$PR_BRANCH"
            NEW_COMMITS=$(git log --format="%H" HEAD..origin/$PR_BRANCH)
            
            for COMMIT in $NEW_COMMITS; do
              roadmap ci track-commit "$COMMIT"
            done
            ;;
            
          "closed")
            if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              echo "ğŸ‰ PR merged! Processing completion logic..."
              
              # Handle merged PR - potential issue completion
              roadmap ci track-pr \
                --number "$PR_NUMBER" \
                --title "$PR_TITLE" \
                --branch "$PR_BRANCH" \
                --state "merged"
                
              # Scan merged commits for completion markers
              echo "ğŸ” Scanning merged commits for issue completion..."
              roadmap ci scan-repository --max-commits 20
              
            else
              echo "âŒ PR closed without merge"
              roadmap ci track-pr \
                --number "$PR_NUMBER" \
                --title "$PR_TITLE" \
                --branch "$PR_BRANCH" \
                --state "closed"
            fi
            ;;
        esac
        
    - name: ğŸ¯ Update Issue States
      run: |
        echo "ğŸ¯ Checking for automated issue state transitions..."
        
        # Get current branch (for push events)
        if [ "${{ github.event_name }}" == "push" ]; then
          CURRENT_BRANCH="${{ github.ref_name }}"
          echo "ğŸ“ Current branch: $CURRENT_BRANCH"
          
          # Auto-transition issues based on branch activity
          if [[ $CURRENT_BRANCH =~ ^(feature|bugfix|hotfix)/ ]]; then
            echo "ğŸ”„ Feature branch activity - checking issue states..."
            roadmap ci track-branch "$CURRENT_BRANCH"
          fi
        fi
        
    - name: ğŸ“Š Generate Activity Summary
      run: |
        echo "ğŸ“Š Generating issue activity summary..."
        
        {
          echo "# ğŸ¯ Issue Activity Summary"
          echo "**Event**: ${{ github.event_name }}"
          echo "**Repository**: ${{ github.repository }}"
          echo "**Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "**PR**: #${{ github.event.number }} - ${{ github.event.pull_request.title }}"
            echo "**Branch**: ${{ github.event.pull_request.head.ref }}"
            echo "**Action**: ${{ github.event.action }}"
            echo ""
          fi
          
          echo "## ğŸ”„ Recent Activity"
          roadmap activity --limit 5 || echo "Activity log unavailable"
          
          echo ""
          echo "## ğŸ¯ Active Issues"
          roadmap issue list --status in-progress || echo "No active issues"
          
          echo ""  
          echo "## ğŸ Recently Completed"
          roadmap issue list --status done --limit 3 || echo "No recent completions"
          
        } > activity-summary.md
        
        echo "ğŸ“‹ Activity Summary Generated:"
        cat activity-summary.md
        
    - name: ğŸ“ˆ Update Metrics
      run: |
        echo "ğŸ“ˆ Updating project metrics..."
        
        # Recalculate progress for milestones
        roadmap recalculate-progress
        
        # Show updated status
        echo "ğŸ“Š Updated project status:"
        roadmap status
        
        echo "ğŸ† Milestone progress:"
        roadmap milestone list

    - name: ğŸš¨ Check for Blockers
      run: |
        echo "ğŸš¨ Checking for blocked issues or dependencies..."
        
        # Future enhancement: dependency resolution
        echo "ğŸ” Dependency checking (future feature)"
        
        # Check for overdue items
        echo "â° Checking for overdue items..."
        roadmap milestone list | grep -E "(overdue|late)" || echo "âœ… No overdue items detected"