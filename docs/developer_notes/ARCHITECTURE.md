# Roadmap Architecture Guide

Complete technical reference for the Roadmap CLI application design, data model, code organization, and implementation patterns.

---

## Part 1: Data Model & User-Facing Architecture

### Overview

Roadmap is a **file-first, git-native issue tracking system**. Every roadmap lives in a `.roadmap/` folder within your git repository, making issues version-controllable and portable.

### File Structure

```text
project-root/
├── .roadmap/
│   ├── config.yaml              # Roadmap configuration & settings
│   ├── roadmap.md               # Main roadmap document (optional)
│   ├── milestones/
│   │   ├── v1-0.md              # Milestone file (one per milestone)
│   │   └── v1-1.md
│   ├── issues/
│   │   ├── issue-abc123.md      # Individual issue files
│   │   ├── issue-def456.md
│   │   └── ...
│   ├── .backups/                # Auto-generated backups
│   │   └── issues-20250101.tar.gz
│   └── .gitignore               # Ignores .backups/ and temp files
│
├── src/
├── README.md
└── .git/
```

### Data Model: Issues

Each issue is a **markdown file with YAML frontmatter**:

```markdown
---
id: issue-abc123
title: Implement user authentication
description: Support OAuth2 for GitHub and Google
status: in-progress
priority: high
assignee: alice
progress: 75
milestone: v1.0
created_at: 2025-01-15T10:00:00Z
updated_at: 2025-01-20T14:30:00Z
tags:
  - backend
  - security
depends_on:
  - issue-def456
blocks:
  - issue-ghi789
---

# Implementation Details

Implement OAuth2 authentication system.

## Acceptance Criteria

- [ ] GitHub OAuth flow works
- [ ] Google OAuth flow works
- [ ] Session tokens are secure
- [ ] Logout clears all sessions

## Technical Notes

- Use Python `authlib` library
- Store tokens in encrypted keyring
- Implement refresh token rotation

## Comments

Alice: Starting implementation today
Bob: I have experience with OAuth2, happy to review
```

#### Issue Fields

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | Yes | Unique identifier (generated by Roadmap) |
| `title` | string | Yes | Brief description of the issue |
| `description` | string | No | Longer description |
| `status` | enum | Yes | One of: `todo`, `in-progress`, `blocked`, `review`, `done` |
| `priority` | enum | Yes | One of: `low`, `medium`, `high`, `critical` |
| `assignee` | string | No | Username of assigned person |
| `progress` | integer (0-100) | No | Completion percentage |
| `milestone` | string | No | Milestone this issue is part of |
| `tags` | array[string] | No | Arbitrary tags for categorization |
| `depends_on` | array[string] | No | Issue IDs this blocks on |
| `blocks` | array[string] | No | Issue IDs this issue blocks |
| `created_at` | ISO8601 | Auto | When the issue was created |
| `updated_at` | ISO8601 | Auto | When the issue was last updated |

### Data Model: Milestones

Milestones are also markdown files:

```markdown
---
id: v1-0
title: v1.0 Release
description: First production-ready release
due_date: 2025-03-31
status: active
---

# v1.0 Release Milestone

Sprint planning for the first stable release.

## Goals

- [ ] All core features stable
- [ ] Security audit complete
- [ ] Documentation finalized
```

#### Milestone Fields

| Field | Type | Notes |
|-------|------|-------|
| `id` | string | Unique identifier |
| `title` | string | Milestone name (e.g., "v1.0 Release") |
| `description` | string | Optional description |
| `due_date` | ISO8601 | When milestone is due |
| `status` | enum | `active`, `completed`, `cancelled` |

### Configuration

`config.yaml` stores settings:

```yaml
---
version: "1.0"
project:
  name: "My Project"
  description: "A great project"

github:
  enabled: true
  owner: username
  repo: project-name
  # Token stored securely in system keyring

output:
  format: rich                    # Default output format (rich, json, csv, plain)
  columns: [title, status, assignee, priority]  # Default columns shown

behavior:
  auto_timestamp: true            # Auto-update timestamps
  auto_id: true                   # Auto-generate IDs
  auto_backup: true               # Auto-backup before operations
```

### Design Principles: Data Model

#### 1. File-First

Issues are files, not database records:
- Human-readable and editable
- Tracked by git
- Portable across systems
- Works offline

#### 2. Plain Text

Markdown + YAML frontmatter:
- Universal (any editor works)
- Version-controllable
- Diffable and reviewable
- Human-readable

#### 3. Offline-First

Everything works locally without internet. GitHub sync is optional.

#### 4. Git-Native

Roadmap data lives in git:
- Full history via `git log`
- Blame tracking via `git blame`
- Branches for experimental workflows
- All git tooling applies

---

## Part 2: Application Architecture

### 6-Layer Architecture

The Roadmap application uses a **strict layered architecture** with clear separation of concerns:

```
Presentation Layer (Output formatting)
        ↓
Adapters Layer (External integration)
        ↓
Infrastructure Layer (Coordination & support)
        ↓
Core Layer (Business logic)
        ↓
Common Layer (Shared utilities)
        ↓
Domain Layer (Pure entities, no dependencies)
```

### Layer 1: Domain (Innermost)

**Location**: `roadmap/core/domain/`

**Responsibility**: Define core business entities and value objects with zero external dependencies.

**Exports**:
- Issue, Milestone, Project domain models
- Status, Priority, IssueType enums
- Exceptions: DomainError, ValidationError

**Allowed Dependencies**:
- None (except Python stdlib)
- Must NOT import from any other roadmap layer

**Components**:
```
core/domain/
├── entities.py              # Core issue/milestone entities
├── value_objects.py         # Value objects (ID, Status, Priority)
└── interfaces.py            # Domain interfaces/contracts
```

**Testing** (`tests/unit/domain/`):
- Tests can use full stack for setup (integration-style fixtures)
- Focus on business logic and domain rules
- Domain tests don't need mocking

---

### Layer 2: Core (Business Logic)

**Location**: `roadmap/core/`

**Responsibility**: Implement application business logic using domain models.

**Allowed Dependencies**:
- ✅ Domain
- ✅ Common (shared utilities)
- ✅ Infrastructure (coordination, observability, validation)
- ❌ NOT direct Adapters (use interfaces instead)

**Components**:
```
core/
├── domain/                      # Domain layer (Layer 1)
├── models/                      # Data models for serialization
├── interfaces/                  # Contracts for adapters to implement
└── services/                    # Business logic services
    ├── baseline/               # Baseline retrieval & building
    ├── comment/                # Comment operations
    ├── git/                    # Git operations
    ├── github/                 # GitHub-specific integration
    ├── health/                 # Health checking services
    ├── initialization/         # Initialization services
    ├── issue/                  # Issue management services
    ├── project/                # Project management
    ├── sync/                   # Sync-related services
    └── validators/             # Validation services
```

**Services** (52+ files organized into 10 subdirectories):
- `IssueService` - Issue CRUD operations
- `SyncPlanExecutor` - Executing sync plans
- `HealthCheckService` - System health checks
- `BaselineRetriever` - Sync baseline reconstruction
- And many more specialized services

**Testing** (`tests/unit/core/`):
- Organized by service type
- Use mocking for adapter dependencies
- Mock infrastructure when needed

---

### Layer 3: Common (Shared Utilities)

**Location**: `roadmap/common/`

**Responsibility**: Provide shared utilities, logging, error handling, configuration.

**Allowed Dependencies**:
- ✅ Infrastructure
- ❌ NOT Core, Domain, or Adapters

**Components**:
```
common/
├── configuration/             # Config loading & validation
│   ├── config.py
│   ├── config_validator.py
│   └── config_models.py
├── errors/                    # Exception hierarchy
│   ├── base_exceptions.py
│   ├── validation_errors.py
│   ├── sync_errors.py
│   └── [etc - ~12 files]
├── logging/                   # Logging configuration
├── formatting/                # Formatting utilities
├── models/                    # Shared data models
├── security/                  # Encryption, credentials
└── services/                  # Shared services (file, path, timezone)
```

**Subdirectories** (Phase 5 reorganization):
- `configuration/` - Config management
- `errors/` - Exception definitions
- `formatting/` - Formatters & utilities
- `logging/` - Logging setup
- `models/` - Shared models
- `security/` - Security utilities
- `services/` - Shared service utilities

**Testing** (`tests/unit/common/`):
- Tests may import from adapters/infrastructure for fixture setup
- Fixtures and assertion helpers live here

---

### Layer 4: Infrastructure (Coordination & Support)

**Location**: `roadmap/infrastructure/`

**Responsibility**: Cross-cutting concerns, coordination between layers, system integration.

**Allowed Dependencies**:
- ✅ Core (coordinates application logic)
- ✅ Common
- ✅ Adapters (coordinates between adapters and core)

**Subdirectories** (organized by concern):
```
infrastructure/
├── coordination/              # RoadmapCore, orchestrators, operations
│   ├── core.py              # RoadmapCore - main coordinator
│   ├── git_coordinator.py
│   ├── issue_coordinator.py
│   └── [orchestrators]
├── git/                       # Git integration operations
│   └── git_integration_ops.py
├── observability/             # Health checks, metrics, traces
│   ├── health.py
│   ├── specialized_health_checkers.py
│   └── instrumentation.py
├── validation/                # Data validation, consistency checks
│   └── [validators]
├── security/                  # Credential & secrets management
│   └── credentials.py
└── maintenance/              # Cleanup, repairs, backups
    └── cleanup.py
```

**Key Coordinators**:
- `RoadmapCore` - Main application coordinator
- `IssueCoordinator` - Issue operation orchestration
- `GitCoordinator` - Git operation coordination

**Testing** (`tests/unit/infrastructure/{subdirectory}/`):
- Can import from adapters (testing infrastructure/adapter coordination)
- Use mocking to avoid tight coupling

---

### Layer 5: Adapters (External Integration)

**Location**: `roadmap/adapters/`

**Responsibility**: Implement interfaces for external systems and user interaction.

**Allowed Dependencies**:
- ✅ Core (implements core interfaces)
- ✅ Common
- ✅ Infrastructure
- ✅ Other Adapters (carefully)

**Subdirectories**:
```
adapters/
├── cli/                       # Command-line interface
│   ├── root.py              # Root command
│   ├── crud/                # CRUD operations
│   ├── analysis/            # Analysis commands
│   ├── config/              # Configuration commands
│   ├── health/              # Health checks
│   └── [command groups]
├── sync/                      # Sync backend selection/execution
├── persistence/               # File storage implementation
├── github/                    # GitHub API integration
├── git/                       # Git operations (via GitPython)
└── presentation/              # Output formatting
```

**CLI Commands Organization** (~21 files in `adapters/cli/`):
- `crud/` - Create, Update, Delete operations
- `analysis/` - List, Kanban, View commands
- `config/` - Configuration management
- `issues/` - Issue-specific commands
- `milestones/` - Milestone management
- `projects/` - Project operations

**Testing** (`tests/unit/adapters/{subdirectory}/`):
- Isolate from other adapters where possible
- Use mocking for external APIs
- Test CLI interaction patterns

---

### Layer 6: Presentation (Output)

**Location**: Conceptually separate (though implemented in adapters)

**Responsibility**: Format and display data to users.

**Components**:
- Output formatters (table, kanban, JSON, CSV)
- Display helpers and utilities
- Rich formatting

**Allowed Dependencies**:
- ✅ Core (domain models)
- ✅ Common
- ✅ Infrastructure
- ✅ Adapters (for display formats)

**Testing** (`tests/unit/presentation/`):
- Test output formatting
- Test data presentation logic
- May import from infrastructure/adapters for testing display

---

### Dependency Rules Summary

```
Domain (layer 1)
  ↑ No imports (stdlib only)

Core (layer 2)
  ↑ Imports: Domain, Common, Infrastructure
  | (Adapters only via interfaces)

Common (layer 3)
  ↑ Imports: Infrastructure

Infrastructure (layer 4)
  ↑ Imports: Core, Common, Adapters

Adapters (layer 5)
  ↑ Imports: Core, Common, Infrastructure, (other Adapters)

Presentation (layer 6)
  ↑ Imports: All layers
```

**Key Rule**: No layer imports layers above it. Flow is always downward.

---

## Part 3: Code Organization

### Directory Structure

```
roadmap/
├── __init__.py                    # Package initialization, exports
├── adapters/                      # ⭐ Adapters Layer
├── core/                          # ⭐ Core Layer
├── common/                        # ⭐ Common Layer
├── infrastructure/                # ⭐ Infrastructure Layer
└── settings.py                    # Global settings
```

### File Organization by Layer

#### Adapters Layer (`roadmap/adapters/`)

**CLI Structure** (21+ files):
```
adapters/cli/
├── root.py                        # Root command (@roadmap)
├── cli_command_helpers.py        # Utilities for CLI commands
├── console_exports.py             # Console re-exports
├── crud/                          # CRUD operations
│   ├── create.py
│   ├── delete.py
│   ├── update.py
│   └── [other CRUD]
├── analysis/                      # Analysis commands
│   ├── list.py
│   ├── kanban.py
│   ├── view.py
│   └── analyze.py
├── config/                        # Configuration
├── health/                        # Health checks
├── init/                          # Initialization
├── issues/                        # Issue-specific
├── milestones/                    # Milestone management
├── projects/                      # Project operations
└── dtos/                          # Data transfer objects
```

#### Core Layer (`roadmap/core/`)

**Services Organization** (52+ files in 10 subdirectories):
```
core/services/
├── baseline/                      # Baseline services
├── comment/                       # Comment operations
├── git/                           # Git services
├── github/                        # GitHub integration
├── health/                        # Health checks
├── initialization/                # Initialization
├── issue/                         # Issue management
├── project/                       # Project management
├── sync/                          # Sync operations
└── validators/                    # Validators
```

#### Common Layer (`roadmap/common/`)

**Organization** (28+ files in 7 subdirectories):
```
common/
├── configuration/                 # Config management (6 files)
├── errors/                        # Error definitions (12 files)
├── formatting/                    # Formatters (5 files)
├── logging/                       # Logging setup (8 files)
├── models/                        # Shared models (7 files)
├── security/                      # Security utils (10 files)
└── services/                      # Shared services (7 files)
```

#### Infrastructure Layer (`roadmap/infrastructure/`)

**Organization** (by concern):
```
infrastructure/
├── coordination/                  # Orchestration
├── git/                           # Git operations
├── observability/                 # Health & metrics
├── validation/                    # Data validation
├── security/                      # Credentials
└── maintenance/                   # Cleanup & repairs
```

### Naming Conventions (Phase 5)

| Pattern | Use Case | Example |
|---------|----------|---------|
| `service_name.py` | Business logic services | `issue_service.py` |
| `name_validator.py` | Validators | `issue_validator.py` |
| `formatter.py` | Formatters | `json_formatter.py` |
| `name_service.py` | Utility services | `file_service.py` |
| `name_client.py` | External clients | `github_client.py` |
| `name_manager.py` | Complex coordination | `sync_state_manager.py` |
| `subdir/` | Feature/concern grouping | `issue/`, `sync/`, `github/` |

### Eliminated Patterns

❌ `*_utils.py` (now `*_service.py` or moved to subdir)
❌ `*_helpers.py` (now `*_service.py`)
❌ `base_*.py` (now `*_base.py` when needed)

---

## Part 4: Testing Architecture

### Test Organization

Tests mirror the application layer structure:

```
tests/
├── unit/                          # Unit tests (isolated components)
│   ├── domain/                   # Domain layer tests
│   ├── core/                     # Core service tests
│   ├── common/                   # Common utilities tests
│   ├── infrastructure/           # Infrastructure tests by concern
│   ├── adapters/                 # Adapter tests by type
│   └── presentation/             # Presentation tests
├── integration/                   # Integration tests (workflows)
├── security/                      # Security-specific tests
├── fixtures/                      # Shared test fixtures
└── conftest.py                   # Root pytest configuration
```

### Test Layer Rules

**Domain Tests** (`tests/unit/domain/`):
- ✅ Can use full stack for setup
- Focus on business logic and domain rules
- No need for mocking

**Core Tests** (`tests/unit/core/`):
- ✅ Mock adapter dependencies
- ✅ Mock infrastructure when testing isolated services
- Import from adapters acceptable for error types core uses

**Common Tests** (`tests/unit/common/`):
- ✅ Import from adapters/infrastructure for fixture setup
- Test shared utilities in isolation

**Infrastructure Tests** (`tests/unit/infrastructure/`):
- ✅ Can import from adapters (testing coordination)
- Use mocking to avoid tight coupling

**Adapter Tests** (`tests/unit/adapters/`):
- ✅ Isolate from other adapters
- Mock external APIs (GitHub, git, etc.)
- Test integration with core services

### Acceptable Violations

- ✅ Domain tests using full stack for setup
- ✅ Common tests importing adapters for fixtures
- ✅ Core tests importing adapter error types (when core service uses them)
- ✅ Infrastructure tests importing adapters (testing coordination)
- ✅ Test fixtures importing from any layer (setup-only)

### Unacceptable Violations

- ❌ Unit tests importing unnecessary implementation details
- ❌ Tests breaking isolation with direct imports
- ❌ Circular imports between test modules
- ❌ Domain/Core tests importing CLI or presentation logic

### Test Statistics

- **Total Tests**: 6,558 (all passing)
- **Unit Tests**: 80+ test files
- **Integration Tests**: 50+ test files
- **Coverage**: 80%+ of codebase
- **Parallel Execution**: 8 workers with xdist
- **Layer Violations**: 51 (down from 96 baseline)

---

## Part 5: Architecture Principles

### 1. Dependency Inversion

- Core defines interfaces
- Adapters implement interfaces
- Never inject concrete adapters into core

**Bad**:
```python
from roadmap.adapters.github.github import GitHubClient
class SyncService:
    def __init__(self):
        self.github = GitHubClient()  # Wrong!
```

**Good**:
```python
from roadmap.core.interfaces.github import GitHubBackendInterface
class SyncService:
    def __init__(self, github: GitHubBackendInterface):
        self.github = github  # Injected interface
```

### 2. Single Responsibility

Each service/layer has one reason to change:
- Domain: Business rules change
- Core: Application logic changes
- Infrastructure: Coordination logic changes
- Adapters: External system integration changes
- Common: Shared utilities change

### 3. Isolation

Each layer can be tested independently:
- Mock dependencies across layer boundaries
- Use interfaces for contracts
- Avoid tight coupling

### 4. Gradual Integration

- **Unit tests**: Single layer + mocked dependencies
- **Integration tests**: Multiple layers working together
- **System tests**: Full application end-to-end

---

## Part 6: Common Implementation Patterns

### Service Initialization

```python
# In infrastructure/coordination/core.py
class RoadmapCore:
    def __init__(self):
        self.persistence = FileStorage()
        self.github_client = GitHubClient()
        self.issue_service = IssueService(self.persistence)
        self.sync_service = SyncService(
            self.github_client,
            self.persistence,
            self.issue_service
        )
```

### Interface Contracts

```python
# In core/interfaces/
from abc import ABC, abstractmethod

class PersistenceInterface(ABC):
    @abstractmethod
    def load(self, path: str) -> dict:
        pass
    
    @abstractmethod
    def save(self, path: str, data: dict) -> None:
        pass

# In adapters/persistence/
class FileStorage(PersistenceInterface):
    def load(self, path: str) -> dict:
        # Implementation
        pass
```

### Testing with Mocks

```python
from unittest.mock import MagicMock
from roadmap.core.services.issue import IssueService

def test_issue_creation():
    mock_persistence = MagicMock(spec=PersistenceInterface)
    service = IssueService(mock_persistence)
    
    result = service.create_issue(title="Test")
    
    mock_persistence.save.assert_called_once()
```

---

## Part 7: Performance Characteristics

### Reading

- **1-100 issues**: < 100ms
- **100-1000 issues**: < 500ms
- **1000-10000 issues**: < 2 seconds

(Bottleneck is file I/O, not Roadmap)

### Writing

- **Single issue update**: < 50ms
- **Batch operations (100 issues)**: < 500ms

### GitHub Sync

- **Pull 100 issues**: < 3 seconds
- **Push 100 issues**: < 5 seconds

---

## Part 8: Migration Path

Adding a new feature:

1. **Define domain models** (Layer 1: Domain)
2. **Implement business logic** (Layer 2: Core/Services)
3. **Integrate with infrastructure** (Layer 4: Infrastructure)
4. **Build adapters** (Layer 5: Adapters)
5. **Add presentation** (Layer 6: Presentation)
6. **Write tests** at each layer (working downward)

---

## Part 9: Current Metrics

### Layer Violation Statistics (January 2026)

| Metric | Value | Status |
|--------|-------|--------|
| Production Code Violations | 97 | ↓ from 685 |
| Test Layer Violations | 51 | ↓ from 96 |
| Circular Imports | 0 | ✅ Clean |
| Core→Adapters Direct Imports | 0 | ✅ Clean |

### Code Quality

- ✅ All pre-commit hooks passing
- ✅ 6,558 tests passing (xdist compatible)
- ✅ Type hints validated (Pyright)
- ✅ Code style enforced (Ruff)
- ✅ Security checks (Bandit)

### Phase 5 Impact

- **Files Changed**: 60+
- **Files Renamed**: 8
- **Files Moved**: 50+
- **Imports Updated**: 125+
- **Circular Dependencies**: 0

---

## Part 10: Quick Reference

### Import Guidelines

**✅ Good**:
```python
from roadmap.core.services.issue import IssueService
from roadmap.core.interfaces.persistence import PersistenceInterface
from roadmap.common.errors import ValidationError
```

**❌ Bad**:
```python
from roadmap.adapters.cli.root import app  # In core
from roadmap.core.services import *       # Wildcard imports
from ...shared.persistence import save   # Non-existent "shared" layer
```

### Common Files to Edit

| Task | Location | File |
|------|----------|------|
| Add issue business logic | core/services/issue/ | `issue_service.py` |
| Add CLI command | adapters/cli/ | `crud/create.py` or new |
| Add error type | common/errors/ | `*_errors.py` |
| Add infrastructure concern | infrastructure/{subdirectory}/ | New file |
| Add formatter | adapters/presentation/ | `*_formatter.py` |

---

**Last Updated**: January 15, 2026  
**Phase**: 6 - Architecture & Code Quality  
**Version**: 1.0 (Consolidated)
