# Architecture: How Roadmap Works

Technical guide to the file structure, data model, and design patterns.

## File Structure

Every Roadmap lives in a `.roadmap/` folder in your git repository:

```
project-root/
├── .roadmap/
│   ├── config.yaml              # Roadmap configuration & settings
│   ├── roadmap.md               # Main roadmap document (optional)
│   ├── milestones/
│   │   ├── v1-0.md              # Milestone file (one per milestone)
│   │   └── v1-1.md
│   ├── issues/
│   │   ├── issue-abc123.md      # Individual issue files
│   │   ├── issue-def456.md
│   │   └── ...
│   ├── .backups/                # Auto-generated backups
│   │   └── issues-20250101.tar.gz
│   └── .gitignore               # Ignores .backups/ and temp files
│
├── src/
├── README.md
└── .git/
```

## Data Model: Issues

Each issue is a **markdown file with YAML frontmatter**:

```markdown
---
id: issue-abc123
title: Implement user authentication
description: Support OAuth2 for GitHub and Google
status: in-progress
priority: high
assignee: alice
progress: 75
milestone: v1.0
created_at: 2025-01-15T10:00:00Z
updated_at: 2025-01-20T14:30:00Z
tags:
  - backend
  - security
depends_on:
  - issue-def456
blocks:
  - issue-ghi789
---

# Implementation Details

Implement OAuth2 authentication system.

## Acceptance Criteria

- [ ] GitHub OAuth flow works
- [ ] Google OAuth flow works
- [ ] Session tokens are secure
- [ ] Logout clears all sessions

## Technical Notes

- Use Python `authlib` library
- Store tokens in encrypted keyring
- Implement refresh token rotation

## Comments

Alice: Starting implementation today
Bob: I have experience with OAuth2, happy to review
```

### Issue Fields

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `id` | string | Yes | Unique identifier (generated by Roadmap) |
| `title` | string | Yes | Brief description of the issue |
| `description` | string | No | Longer description |
| `status` | enum | Yes | One of: `todo`, `in-progress`, `blocked`, `review`, `done` |
| `priority` | enum | Yes | One of: `low`, `medium`, `high`, `critical` |
| `assignee` | string | No | Username of assigned person |
| `progress` | integer (0-100) | No | Completion percentage |
| `milestone` | string | No | Milestone this issue is part of |
| `tags` | array[string] | No | Arbitrary tags for categorization |
| `depends_on` | array[string] | No | Issue IDs this blocks on |
| `blocks` | array[string] | No | Issue IDs this issue blocks |
| `created_at` | ISO8601 | Auto | When the issue was created |
| `updated_at` | ISO8601 | Auto | When the issue was last updated |

## Data Model: Milestones

Milestones are also markdown files:

```markdown
---
id: v1-0
title: v1.0 Release
description: First production-ready release
due_date: 2025-03-31
status: active
---

# v1.0 Release Milestone

Sprint planning for the first stable release.

## Goals

- [ ] All core features stable
- [ ] Security audit complete
- [ ] Documentation finalized
```

### Milestone Fields

| Field | Type | Notes |
|-------|------|-------|
| `id` | string | Unique identifier |
| `title` | string | Milestone name (e.g., "v1.0 Release") |
| `description` | string | Optional description |
| `due_date` | ISO8601 | When milestone is due |
| `status` | enum | `active`, `completed`, `cancelled` |

## Configuration

`config.yaml` stores settings:

```yaml
---
version: "1.0"
project:
  name: "My Project"
  description: "A great project"

github:
  enabled: true
  owner: username
  repo: project-name
  # Token stored securely in system keyring

output:
  format: rich                    # Default output format (rich, json, csv, plain)
  columns: [title, status, assignee, priority]  # Default columns shown

behavior:
  auto_timestamp: true            # Auto-update timestamps
  auto_id: true                   # Auto-generate IDs
  auto_backup: true               # Auto-backup before operations
```

## How CLI Commands Map to Files

### `roadmap issue create "Title"`

Creates a new file:
```
.roadmap/issues/issue-<random>.md
```

### `roadmap issue list`

Reads all files in `.roadmap/issues/` and displays them.

### `roadmap issue update issue-id --status done`

Modifies the `status` field in the issue's YAML frontmatter.

### `roadmap milestone create "v1.0"`

Creates a new file:
```
.roadmap/milestones/v1-0.md
```

## Git Integration

### Automatic Status Updates

When you commit with certain keywords, Roadmap auto-updates issue status:

```bash
git commit -m "fixes issue-abc123"
# Triggers: roadmap issue update issue-abc123 --status done --progress 100

git commit -m "Progress on issue-abc123: 50%"
# Triggers: roadmap issue update issue-abc123 --progress 50

git commit -m "[closes roadmap:issue-id]"
# Triggers: roadmap issue update issue-id --status done
```

**How it works:**

1. Git hooks watch your commits
2. Commit message is parsed for keywords (`fixes`, `closes`, `resolves`)
3. Issue ID is extracted (e.g., `issue-abc123`)
4. Status is updated automatically

### Commit Message Patterns Supported

| Pattern | Action |
|---------|--------|
| `fixes issue-id` | Mark done (100% progress) |
| `closes issue-id` | Mark done (100% progress) |
| `resolves issue-id` | Mark done (100% progress) |
| `[closes roadmap:issue-id]` | Mark done (100% progress) |
| `wip issue-id` | Mark in-progress |
| `progress issue-id: 50%` | Set progress to 50% |

## Output Formats

### Rich (Default)

Human-readable with colors and formatting:

```
Title                              │ Status       │ Priority │ Assignee
─────────────────────────────────────────────────────────────────────────
Implement authentication           │ In Progress  │ High     │ alice
Fix database query performance     │ Blocked      │ Medium   │ bob
```

### JSON

Machine-readable:

```json
[
  {
    "id": "issue-abc123",
    "title": "Implement authentication",
    "status": "in-progress",
    "priority": "high",
    "assignee": "alice"
  }
]
```

Use with `jq` for querying:

```bash
roadmap issue list --format json | jq '.[] | select(.priority == "high")'
```

### CSV

For spreadsheets:

```csv
id,title,status,priority,assignee
issue-abc123,Implement authentication,in-progress,high,alice
issue-def456,Fix query performance,blocked,medium,bob
```

### Plain Text

POSIX-friendly for piping:

```
issue-abc123 | Implement authentication | in-progress | high | alice
issue-def456 | Fix query performance | blocked | medium | bob
```

## Performance Characteristics

### Reading

- **1-100 issues**: < 100ms
- **100-1000 issues**: < 500ms
- **1000-10000 issues**: < 2 seconds

(Bottleneck is file I/O, not Roadmap)

### Writing

- **Single issue update**: < 50ms
- **Batch operations (100 issues)**: < 500ms

### GitHub Sync

- **Pull 100 issues**: < 3 seconds
- **Push 100 issues**: < 5 seconds

## Design Principles

### 1. **File-First**

Issues are files, not database records. This means:
- Human-readable and editable
- Tracked by git
- Portable
- Works offline

### 2. **Plain Text**

Markdown + YAML frontmatter is:
- Universal (any editor works)
- Version-controllable
- Diffable
- Human-readable

### 3. **Composable**

Output JSON/CSV, so you can pipe to other tools:

```bash
roadmap issue list --format json | jq '.[] | ...' | awk '...'
```

### 4. **Offline-First**

Everything works locally without internet. GitHub sync is optional.

### 5. **Git-Native**

Roadmap data lives in git, so:
- Full history via `git log`
- Blame tracking via `git blame`
- Branches for experimental workflows
- All git tooling applies

## Extending Roadmap

### Custom Fields

In v1.0, you can add custom fields to the YAML:

```yaml
---
id: issue-abc123
title: Backend work
custom_field: custom_value
my_team: platform
estimated_hours: 8
---
```

Roadmap ignores unknown fields, so they don't break anything.

### Custom Scripts

Since output is JSON/CSV, you can build custom tooling:

```bash
#!/bin/bash
# Example: Generate burndown chart

roadmap milestone list --format json | \
  jq '.[] | {name, progress}' | \
  python plot_burndown.py
```

### Plugins (v1.1+)

In v1.1, we're planning:
- Hook system (pre-update, post-update, etc.)
- Python plugin API
- Community plugin registry

---

## Data Validation

Roadmap validates:

✅ Required fields present
✅ Field types correct (status is enum, progress is 0-100, etc.)
✅ No duplicate IDs
✅ Referenced IDs exist (depends_on, blocks, milestone)
✅ YAML syntax valid

Invalid files are reported by:

```bash
roadmap health check      # Validates all files
roadmap cleanup           # Fixes common issues
```

## Backups

Roadmap auto-creates backups:

```
.roadmap/.backups/
├── issues-20250115-100000.tar.gz    # Before major operations
├── issues-20250115-140000.tar.gz
└── issues-20250115-180000.tar.gz
```

Restore with:

```bash
roadmap cleanup --restore
```

---

## Next Steps

- **[Quick Start](QUICK_START.md)** - Get running in 5 minutes
- **[Workflows](WORKFLOWS.md)** - Real-world usage patterns
- **[FAQ](FAQ.md)** - Common questions
